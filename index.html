<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HeyReach API Dashboard v3.1</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --success-color: #198754;
            --error-color: #dc3545;
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: var(--surface-color);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        h1, h2 {
            color: var(--primary-color);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .step {
            margin-bottom: 2rem;
            padding: 1.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: #fdfdfd;
        }
        .step-header {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        .step-number {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        label {
            display: block;
            margin-bottom: .5rem;
            font-weight: bold;
        }
        input[type="text"], input[type="password"], select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            margin-bottom: 1rem;
        }
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s ease;
        }
        button:hover:not(:disabled) {
            background-color: #0b5ed7;
        }
        button:disabled {
            background-color: var(--secondary-color);
            cursor: not-allowed;
        }
        #api-status {
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-top: 1rem;
            text-align: center;
        }
        .status-success { background-color: #d1e7dd; color: #0f5132; }
        .status-error { background-color: #f8d7da; color: #842029; }
        #report-output {
            margin-top: 2rem;
            padding: 1.5rem;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            display: none;
        }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }
        .report-item {
            background: #f9f9f9;
            padding: 1rem;
            border-radius: 5px;
            border-left: 5px solid var(--secondary-color);
        }
        .report-item h4 { margin: 0 0 5px 0; font-size: 0.9em; }
        .report-item p {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0;
            color: var(--primary-color);
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <h1> HeyReach API Dashboard v3.1</h1>

        <div class="step">
            <div class="step-header"><div class="step-number">0</div><div>Podaj klucz API</div></div>
            <label for="api-key">Tw贸j klucz X-API-KEY:</label>
            <input type="password" id="api-key" placeholder="Wklej sw贸j klucz API tutaj">
            <button id="check-api-key">Zapisz i Zweryfikuj Klucz</button>
            <div id="api-status"></div>
        </div>

        <div class="step">
             <div class="step-header"><div class="step-number">1</div><div>Wywietl statystyki kampanii</div></div>
             <label for="campaign-select">Wybierz kampani lub zobacz podsumowanie:</label>
             <select id="campaign-select" disabled><option value="">Najpierw zweryfikuj klucz API</option></select>
        </div>

        <div class="loader" id="loader"></div>

        <div id="report-output">
            <h2>Statystyki Postpu</h2>
            <div id="report-summary"></div>
            <div id="report-details" class="report-grid"></div>
            <br>
            <button id="save-pdf" style="background-color: var(--success-color);">Zapisz jako PDF</button>
        </div>
    </div>

    <script>
        const { jsPDF } = window.jspdf;

        const apiKeyInput = document.getElementById('api-key');
        const checkApiKeyBtn = document.getElementById('check-api-key');
        const apiStatusDiv = document.getElementById('api-status');
        const campaignSelect = document.getElementById('campaign-select');
        const reportOutputDiv = document.getElementById('report-output');
        const reportSummaryDiv = document.getElementById('report-summary');
        const reportDetailsDiv = document.getElementById('report-details');
        const savePdfBtn = document.getElementById('save-pdf');
        const loader = document.getElementById('loader');
        
        const PROXY_URL = 'https://shy-meadow-dba0.lammelstanislaw.workers.dev/';

        let verifiedApiKey = null;
        let allCampaigns = [];

        const showLoader = () => loader.style.display = 'block';
        const hideLoader = () => loader.style.display = 'none';
        
        const showApiStatus = (message, isSuccess) => {
            apiStatusDiv.textContent = message;
            apiStatusDiv.className = isSuccess ? 'status-success' : 'status-error';
        };
        
        const apiCall = async (endpoint, method = 'POST', body = null) => {
            const headers = { 'X-API-KEY': verifiedApiKey };
            if (endpoint === 'api/public/campaign/GetAll') {
                headers['Accept'] = 'text/plain';
            } else {
                headers['Accept'] = 'application/json';
            }
            const options = { method, headers };
            if (body) {
                headers['Content-Type'] = 'application/json';
                options.body = JSON.stringify(body);
            }
            const response = await fetch(`${PROXY_URL}${endpoint}`, options);
            if (!response.ok) {
                let errorText = '';
                try { errorText = await response.text(); } catch (e) {}
                throw new Error(`Bd API (${response.status}): ${errorText || response.statusText}`);
            }
            const responseText = await response.text();
            try {
                return responseText ? JSON.parse(responseText) : {};
            } catch (e) {
                console.error("Bd parsowania JSON:", e, "Otrzymany tekst:", responseText);
                throw new Error("Bd odpowiedzi serwera: nieprawidowy format JSON.");
            }
        };
        
        const handleCheckApiKey = async () => {
            const key = apiKeyInput.value.trim();
            if (!key) return showApiStatus('Prosz wprowadzi klucz API.', false);
            if (!PROXY_URL.startsWith('https://')) return showApiStatus('Prosz najpierw ustawi adres PROXY_URL w kodzie.', false);

            showLoader();
            apiStatusDiv.textContent = '';
            verifiedApiKey = key;
            try {
                const response = await fetch(`${PROXY_URL}api/public/auth/CheckApiKey`, { headers: { 'X-API-KEY': key } });
                if (!response.ok) throw new Error('Nieprawidowy klucz API lub bd sieci.');

                localStorage.setItem('heyreach_api_key', key);
                showApiStatus('Klucz API jest poprawny!', true);
                campaignSelect.disabled = false;
                await handleFetchCampaigns();
            } catch (error) {
                console.error("Bd weryfikacji klucza:", error);
                verifiedApiKey = null;
                showApiStatus(error.message, false);
            } finally {
                hideLoader();
            }
        };

        const handleFetchCampaigns = async () => {
            if (!verifiedApiKey) return;
            showLoader();
            try {
                const payload = { offset: 0, limit: 100 };
                const data = await apiCall('api/public/campaign/GetAll', 'POST', payload);
                allCampaigns = data.items || [];
                
                campaignSelect.innerHTML = ''; // Wyczy list przed dodaniem nowych
                
                // Dodaj opcj podsumowania na pocztku
                const summaryOption = document.createElement('option');
                summaryOption.value = 'all';
                summaryOption.textContent = '-- Poka偶 podsumowanie wszystkich --';
                campaignSelect.appendChild(summaryOption);
                
                allCampaigns.forEach(camp => {
                    const option = document.createElement('option');
                    option.value = camp.id;
                    option.textContent = `${camp.name} (ID: ${camp.id})`;
                    campaignSelect.appendChild(option);
                });
                
                // Domylnie poka偶 podsumowanie
                campaignSelect.value = 'all';
                displayAggregateStats();

            } catch (error) {
                console.error("Bd pobierania kampanii:", error);
                alert(`Nie udao si pobra kampanii: ${error.message}`);
            } finally {
                hideLoader();
            }
        };

        const displayCampaignStats = (campaignId) => {
            const campaign = allCampaigns.find(c => c.id === parseInt(campaignId));
            if (!campaign) {
                reportOutputDiv.style.display = 'none';
                return;
            }

            reportSummaryDiv.innerHTML = `<p><strong>Kampania:</strong> ${campaign.name} (#${campaign.id})</p>`;
            
            const stats = campaign.progressStats;
            if (stats) {
                reportDetailsDiv.innerHTML = `
                    <div class="report-item"><h4>Wszystkich lead贸w</h4><p>${stats.totalUsers}</p></div>
                    <div class="report-item"><h4>W trakcie</h4><p>${stats.totalUsersInProgress}</p></div>
                    <div class="report-item"><h4>Oczekujcych</h4><p>${stats.totalUsersPending}</p></div>
                    <div class="report-item"><h4>Zakoczonych</h4><p>${stats.totalUsersFinished}</p></div>
                    <div class="report-item"><h4>Nieudanych</h4><p>${stats.totalUsersFailed}</p></div>
                    <div class="report-item"><h4>Wykluczonych</h4><p>${stats.totalUsersExcluded}</p></div>`;
            } else {
                reportDetailsDiv.innerHTML = `<p>Brak szczeg贸owych statystyk dla tej kampanii (prawdopodobnie jest w statusie DRAFT).</p>`;
            }
            
            reportOutputDiv.style.display = 'block';
        };

        const displayAggregateStats = () => {
            const summary = { totalUsers: 0, totalUsersInProgress: 0, totalUsersPending: 0, totalUsersFinished: 0, totalUsersFailed: 0, totalUsersExcluded: 0 };
            
            allCampaigns.forEach(campaign => {
                if (campaign.progressStats) {
                    summary.totalUsers += campaign.progressStats.totalUsers;
                    summary.totalUsersInProgress += campaign.progressStats.totalUsersInProgress;
                    summary.totalUsersPending += campaign.progressStats.totalUsersPending;
                    summary.totalUsersFinished += campaign.progressStats.totalUsersFinished;
                    summary.totalUsersFailed += campaign.progressStats.totalUsersFailed;
                    summary.totalUsersExcluded += campaign.progressStats.totalUsersExcluded;
                }
            });

            reportSummaryDiv.innerHTML = `<p><strong>Podsumowanie dla ${allCampaigns.length} kampanii</strong></p>`;
            reportDetailsDiv.innerHTML = `
                <div class="report-item"><h4>Wszystkich lead贸w</h4><p>${summary.totalUsers}</p></div>
                <div class="report-item"><h4>W trakcie</h4><p>${summary.totalUsersInProgress}</p></div>
                <div class="report-item"><h4>Oczekujcych</h4><p>${summary.totalUsersPending}</p></div>
                <div class="report-item"><h4>Zakoczonych</h4><p>${summary.totalUsersFinished}</p></div>
                <div class="report-item"><h4>Nieudanych</h4><p>${summary.totalUsersFailed}</p></div>
                <div class="report-item"><h4>Wykluczonych</h4><p>${summary.totalUsersExcluded}</p></div>`;
            
            reportOutputDiv.style.display = 'block';
        };

        const handleSavePdf = () => {
            const selectedValue = campaignSelect.value;
            if (!selectedValue) return alert("Najpierw wybierz kampani lub podsumowanie.");

            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Statystyki Postpu Kampanii HeyReach", 14, 22);

            let tableData = [];
            
            if (selectedValue === 'all') {
                const summaryTitle = `Podsumowanie dla ${allCampaigns.length} kampanii`;
                doc.autoTable({ startY: 30, body: [['', summaryTitle]], theme: 'plain' });
                
                const summary = { totalUsers: 0, totalUsersInProgress: 0, totalUsersPending: 0, totalUsersFinished: 0, totalUsersFailed: 0, totalUsersExcluded: 0 };
                allCampaigns.forEach(campaign => {
                    if (campaign.progressStats) {
                        summary.totalUsers += campaign.progressStats.totalUsers;
                        summary.totalUsersInProgress += campaign.progressStats.totalUsersInProgress;
                        summary.totalUsersPending += campaign.progressStats.totalUsersPending;
                        summary.totalUsersFinished += campaign.progressStats.totalUsersFinished;
                        summary.totalUsersFailed += campaign.progressStats.totalUsersFailed;
                        summary.totalUsersExcluded += campaign.progressStats.totalUsersExcluded;
                    }
                });
                tableData = Object.entries(summary).map(([key, value]) => [key.replace('totalUsers', ''), value]);
                tableData[0][0] = 'Wszystkich lead贸w';
                tableData[1][0] = 'W trakcie';
                tableData[2][0] = 'Oczekujcych';
                tableData[3][0] = 'Zakoczonych';
                tableData[4][0] = 'Nieudanych';
                tableData[5][0] = 'Wykluczonych';

            } else {
                const campaign = allCampaigns.find(c => c.id === parseInt(selectedValue));
                if (!campaign) return;

                doc.autoTable({ startY: 30, body: [['Kampania', `${campaign.name} (#${campaign.id})`]], theme: 'plain' });
                const stats = campaign.progressStats;
                if (stats) {
                    tableData.push(
                        ['Wszystkich lead贸w', stats.totalUsers], ['W trakcie', stats.totalUsersInProgress],
                        ['Oczekujcych', stats.totalUsersPending], ['Zakoczonych', stats.totalUsersFinished],
                        ['Nieudanych', stats.totalUsersFailed], ['Wykluczonych', stats.totalUsersExcluded]
                    );
                }
            }
            
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 10,
                head: [['Metryka', 'Warto']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [13, 110, 253] }
            });

            doc.save(`statystyki-heyreach-${selectedValue}.pdf`);
        };

        document.addEventListener('DOMContentLoaded', () => {
            const savedKey = localStorage.getItem('heyreach_api_key');
            if (savedKey) {
                apiKeyInput.value = savedKey;
                if (!PROXY_URL.includes('Wklej_TUTAJ_SWOJ_ADRES_WORKERA')) {
                    handleCheckApiKey();
                }
            }
        });

        checkApiKeyBtn.addEventListener('click', handleCheckApiKey);
        campaignSelect.addEventListener('change', (event) => {
            const selectedValue = event.target.value;
            if (selectedValue === 'all') {
                displayAggregateStats();
            } else if (selectedValue) {
                displayCampaignStats(selectedValue);
            } else {
                reportOutputDiv.style.display = 'none';
            }
        });
        savePdfBtn.addEventListener('click', handleSavePdf);
    </script>
</body>
</html>